## å‰è¨€


åœ¨å‰ä¸€ç« ï¼Œæˆ‘ä»¬å­¦ä¼šå¦‚ä½•åœ¨ `Kubernetes`Â å†…éƒ¨ç½²è‡ªå·±çš„ç¬¬ä¸€ä¸ªåº”ç”¨ã€‚ä½†æ˜¯åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬è¿˜ä¼šé‡åˆ°ä¸€äº›ç‰¹å®šåœºæ™¯ï¼š


> A ç”¨æˆ·æ˜¯VIPï¼Œæˆ‘æ€ä¹ˆæ‰èƒ½è®©VIPç”¨æˆ·çœ‹åˆ°å†…æµ‹ç‰ˆæœ¬å‘¢ï¼Ÿ
> æˆ‘ä¸æƒ³åœæœºï¼Œæ€ä¹ˆå‘å¸ƒæ–°ç‰ˆæœ¬å‘¢ï¼Ÿ
> å¦‚ä½•è®©æ–°ç‰ˆæœ¬æœåŠ¡åªå¼€æ”¾å°æµé‡è®¿é—®å‘¢ï¼Ÿ
> ......



æ˜¾ç„¶ï¼Œè¿™äº›åœºæ™¯å¯¹äºæˆ‘ä»¬å•çº¯çš„è®¿é—®æ¥çœ‹æ˜¯æ— æ³•åšåˆ°çš„ã€‚é‚£ä¹ˆæœ‰ä»€ä¹ˆå¥½åŠæ³•å‘¢ï¼Ÿ


## ä»€ä¹ˆæ˜¯ç°åº¦å‘å¸ƒ


é¦–å…ˆæˆ‘ä»¬æ¥çœ‹**ç°åº¦å‘å¸ƒ**ã€‚ç°åº¦å‘å¸ƒæ˜¯ä¸€ç§å‘å¸ƒæ–¹å¼ï¼Œä¹Ÿå« `é‡‘ä¸é›€å‘å¸ƒ`Â ã€‚**èµ·æºæ˜¯çŸ¿å·¥åœ¨ä¸‹äº•ä¹‹å‰ä¼šå…ˆæ”¾ä¸€åªé‡‘ä¸é›€åˆ°äº•é‡Œï¼Œå¦‚æœé‡‘ä¸é›€ä¸å«äº†ï¼Œå°±ä»£è¡¨ç“¦æ–¯æµ“åº¦é«˜ã€‚åŸå› æ˜¯é‡‘ä¸é›€å¯¹ç“¦æ–¯æ°”ä½“å¾ˆæ•æ„Ÿã€‚**è¿™å°±æ˜¯é‡‘ä¸é›€å‘å¸ƒçš„åˆæ¥ï¼Œéå¸¸å½¢è±¡åœ°æè¿°äº†æˆ‘ä»¬çš„å‘å¸ƒè¡Œä¸ºã€‚


ç°åº¦å‘å¸ƒçš„åšæ³•æ˜¯ï¼šä¼šåœ¨ç°å­˜æ—§åº”ç”¨çš„åŸºç¡€ä¸Šï¼Œå¯åŠ¨ä¸€ä¸ªæ–°ç‰ˆåº”ç”¨ã€‚ä½†æ˜¯æ–°ç‰ˆåº”ç”¨å¹¶ä¸ä¼šç›´æ¥è®©ç”¨æˆ·è®¿é—®ã€‚è€Œæ˜¯å…ˆè®©æµ‹è¯•åŒå­¦å»è¿›è¡Œæµ‹è¯•ã€‚å¦‚æœæ²¡æœ‰é—®é¢˜ï¼Œåˆ™å¯ä»¥å°†çœŸæ­£çš„ç”¨æˆ·æµé‡æ…¢æ…¢å¯¼å…¥åˆ°æ–°ç‰ˆä¸Šã€‚åœ¨è¿™ä¸­é—´ï¼ŒæŒç»­å¯¹æ–°ç‰ˆæœ¬è¿è¡ŒçŠ¶æ€åšè§‚å¯Ÿï¼Œç›´åˆ°æ…¢æ…¢åˆ‡æ¢è¿‡å»ï¼Œ**è¿™å°±æ˜¯æ‰€è°“çš„A/Bæµ‹è¯•ã€‚** å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥æ‹›å‹Ÿä¸€äº› **ç°åº¦ç”¨æˆ·ï¼Œ** ç»™ä»–ä»¬è®¾ç½®ç‹¬æœ‰çš„ç°åº¦æ ‡ç¤ºï¼ˆCookieï¼ŒHeaderï¼‰ï¼Œæ¥è®©ä»–ä»¬å¯ä»¥è®¿é—®åˆ°æ–°ç‰ˆåº”ç”¨ã€‚

å½“ç„¶ï¼Œå¦‚æœä¸­é—´åˆ‡æ¢å‡ºç°é—®é¢˜ï¼Œä¹Ÿåº”è¯¥å°†æµé‡è¿…é€Ÿåœ°åˆ‡æ¢åˆ°è€åº”ç”¨ä¸Šã€‚


![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7d5513b9e9e7410e959b99ccac9a2765~tplv-k3u1fbpfcp-zoom-1.image)


## å®ç°æ–¹æ¡ˆ


åœ¨ä¸Šä¸€ç« èŠ‚ï¼Œæˆ‘ä»¬ä½¿ç”¨ `k8s` éƒ¨ç½²äº† `ingress` ã€‚è¿™é‡Œæˆ‘ä»¬å°±åˆ©ç”¨ `ingress annotations` ä¸­çš„ `canary` é…ç½®é¡¹æ¥å®ç°ç°åº¦å‘å¸ƒé€»è¾‘ã€‚


### 1. å‡†å¤‡æ–°ç‰ˆæœ¬çš„ Service


åœ¨å¼€å§‹å‡†å¤‡ç°åº¦ä¹‹å‰ï¼Œéœ€è¦å‡†å¤‡ä¸€å¥—æ–°ç¯å¢ƒä»¥å¤‡æµé‡åˆ‡åˆ†ã€‚åˆ‡æ¢åˆ° `deployment` ç›®å½•ï¼Œæˆ‘ä»¬æ–°å¯åŠ¨ä¸€å¥— `v2` çš„ç¯å¢ƒé…ç½®ï¼Œåœ¨è¿™é‡Œå¯ä»¥å°†åŸå…ˆ `v1` çš„é…ç½®æ–‡ä»¶ï¼Œæ‹·è´ä¸€ä»½æ›¿æ¢ä¸º `v2` çš„é•œåƒï¼š
```shell
cd deployment && cp v1.yaml v2.yaml
```


ä¿®æ”¹ `v2.yaml`ï¼Œå°† `Deployment Name`ï¼Œ `Service Name` å’ŒåŒ¹é…è§„åˆ™éƒ½æ›¿æ¢ä¸º `v2` ï¼Œå¹¶å°†é•œåƒç‰ˆæœ¬æ›¿æ¢ä¸º `v2`
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: front-v2
spec:
  selector:
    matchLabels:
      app: nginx-v2
  replicas: 3
  template:
    metadata:
      labels:
        app: nginx-v2
    spec:
      containers:
      - name: nginx
        image: registry.cn-hangzhou.aliyuncs.com/janlay/k8s_test:v2
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: front-service-v2
spec:
  selector:
    app: nginx-v2
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: NodePort
```


æ¥ç€ä½¿ç”¨ `kubectl apply` å‘½ä»¤ä½¿å…¶é…ç½®ç”Ÿæ•ˆï¼š
```shell
kubectl apply -f ./v2.yaml
```


### 2. æ ¹æ®ä¸åŒæ–¹æ¡ˆè¿›è¡Œåˆ‡åˆ†


#### æ ¹æ® Cookie åˆ‡åˆ†æµé‡


åŸºäº `Cookie` åˆ‡åˆ†æµé‡ã€‚è¿™ç§å®ç°åŸç†ä¸»è¦æ ¹æ®**ç”¨æˆ·è¯·æ±‚ä¸­çš„ Cookie æ˜¯å¦å­˜åœ¨ç°åº¦æ ‡ç¤º Cookie**å»åˆ¤æ–­æ˜¯å¦ä¸ºç°åº¦ç”¨æˆ·ï¼Œå†å†³å®šæ˜¯å¦è¿”å›ç°åº¦ç‰ˆæœ¬æœåŠ¡ã€‚


æˆ‘ä»¬æ–°å»ºä¸€ä¸ªå…¨æ–°çš„ ingress é…ç½®æ–‡ä»¶ï¼Œåç§°å« `gary` ï¼š
```shell
cd ./ingress && vim ./gray.yaml
```


è¾“å…¥ä»¥ä¸‹é…ç½®ï¼š
```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: nginx-demo-canary
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/canary: "true"
    nginx.ingress.kubernetes.io/canary-by-cookie: "users_from_Beijing"
spec:
  rules:
  - http:
      paths: 
       - backend:
          serviceName: front-service-v2
          servicePort: 80
  backend:
     serviceName: front-service-v2
     servicePort: 80
```


æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ `annotations` è¿™é‡Œï¼Œæœ‰ä¸¤ä¸ªå…³äºç°åº¦çš„é…ç½®é¡¹ã€‚åˆ†åˆ«æ˜¯ï¼š


- nginx.ingress.kubernetes.io/canaryï¼šå¯é€‰å€¼ä¸º `true / false` ã€‚ä»£è¡¨æ˜¯å¦å¼€å¯ç°åº¦åŠŸèƒ½
- nginx.ingress.kubernetes.io/canary-by-cookieï¼šç°åº¦å‘å¸ƒ `cookie` çš„ `key`ã€‚å½“ `key` å€¼ç­‰äº `always` æ—¶ï¼Œç°åº¦è§¦å‘ç”Ÿæ•ˆã€‚ç­‰äºå…¶ä»–å€¼æ—¶ï¼Œåˆ™ä¸ä¼šèµ°ç°åº¦ç¯å¢ƒã€‚



ä¿å­˜åï¼Œä½¿ç”¨ `kubectl apply` ç”Ÿæ•ˆé…ç½®æ–‡ä»¶æŸ¥çœ‹æ•ˆæœï¼š
```shell
kubectl apply -f ./gray.yaml
```


æ‰§è¡ŒæˆåŠŸåï¼Œå¯ä»¥ä½¿ç”¨ `kubectl get svc` å‘½ä»¤æ¥è·å– `ingress` çš„å¤–éƒ¨ç«¯å£ï¼š
```shell
kubectl -n ingress-nginx get svc
```
> -n: æ ¹æ®èµ„æºåç§°è¿›è¡Œæ¨¡ç³ŠæŸ¥è¯¢



å…¶ä¸­ï¼Œ`PORT` å­—æ®µæ˜¯æˆ‘ä»¬å¯ä»¥è®¿é—®çš„å¤–éƒ¨ç«¯å£ã€‚80ä¸º `ingress` å†…éƒ¨ç«¯å£ï¼Œ31234 ä¸ºå¤–éƒ¨ç«¯å£ã€‚
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ab31c3f403854ccdac118e9c3068a15a~tplv-k3u1fbpfcp-zoom-1.image)


æˆ‘ä»¬è®¿é—® [http://IP:31234/](http://172.16.81.170:31234/) å¯ä»¥æ­£å¸¸è®¿é—®åˆ°é¡µé¢ï¼š
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/671136d95607469aaa1dbd061a1f247e~tplv-k3u1fbpfcp-zoom-1.image)
æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨chromeæ§åˆ¶å°ä¸­æ‰‹åŠ¨è®¾ç½®ä¸€ä¸ª cookieã€‚keyä¸º `users_from_Beijing` ï¼Œå€¼ä¸º `always`
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ff73757bd88941ba83f1a87f754fdc3e~tplv-k3u1fbpfcp-zoom-1.image)




åˆ·æ–°é¡µé¢ï¼Œå‘ç°æˆ‘ä»¬è®¿é—®çš„æ˜¯v2ã€‚ç°åº¦å‘å¸ƒç¯å¢ƒæ­å»ºæˆåŠŸ
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5b91c07762b24d48a14a6c0f02bb8d87~tplv-k3u1fbpfcp-zoom-1.image)




#### åŸºäº Header åˆ‡åˆ†æµé‡


åŸºäº `Header` åˆ‡åˆ†æµé‡ï¼Œè¿™ç§å®ç°åŸç†ä¸»è¦æ ¹æ®**ç”¨æˆ·è¯·æ±‚ä¸­çš„ header æ˜¯å¦å­˜åœ¨ç°åº¦æ ‡ç¤º header**å»åˆ¤æ–­æ˜¯å¦ä¸ºç°åº¦ç”¨æˆ·ï¼Œå†å†³å®šæ˜¯å¦è¿”å›ç°åº¦ç‰ˆæœ¬æœåŠ¡ã€‚


å½“ç„¶é…ç½®ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦ä¿®æ”¹ `annotations` é…ç½®é¡¹å³å¯ï¼š


- nginx.ingress.kubernetes.io/canary-by-headerï¼šè¦ç°åº¦ `header` çš„ `key` å€¼
- nginx.ingress.kubernetes.io/canary-by-header-value: è¦ç°åº¦ `header` çš„ `value` å€¼



ä¿å­˜åï¼Œä½¿ç”¨ `kubectl apply` ç”Ÿæ•ˆé…ç½®æ–‡ä»¶ï¼š
```shell
kubectl apply -f ./gray.yaml
```


å¦‚ä½•æŸ¥çœ‹æ•ˆæœå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `curl` å‘½ä»¤æ¥åŠ headerå¤´å»è¯·æ±‚è®¿é—®è°ƒç”¨ï¼š
```yaml
curl --header 'headerçš„key:headerçš„value' 127.0.0.1:ç«¯å£å€¼
```
#### 
ç”±äºæˆ‘è¿™é‡Œé…ç½®çš„ç°åº¦ `header` ä¸º `janlay` ï¼Œ `value` ä¸º `isme` ï¼Œæ‰€ä»¥å¦‚ä»¥ä¸‹ç»“æœï¼š


é€šè¿‡å¯¹æ¯”å‘ç°ï¼Œå½“ `janlay` ä¸æ˜¯ `isme` æ—¶ï¼Œç°åº¦å¤±æ•ˆã€‚éªŒè¯æˆåŠŸ
#### ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/82679dba06094a6f98f3e1d699817112~tplv-k3u1fbpfcp-zoom-1.image)
#### åŸºäºæƒé‡åˆ‡åˆ†æµé‡


è¿™ç§å®ç°åŸç†ä¸»è¦æ˜¯æ ¹æ®ç”¨æˆ·è¯·æ±‚ï¼Œé€šè¿‡æ ¹æ®ç°åº¦ç™¾åˆ†æ¯”å†³å®šæ˜¯å¦è½¬å‘åˆ°ç°åº¦æœåŠ¡ç¯å¢ƒä¸­


åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¿®æ”¹ `annotations` é…ç½®é¡¹å³å¯ï¼š


- nginx.ingress.kubernetes.io/canary-weightï¼šå€¼æ˜¯å­—ç¬¦ä¸²ï¼Œä¸º `0-100` çš„æ•°å­—ï¼Œä»£è¡¨ç°åº¦ç¯å¢ƒå‘½ä¸­æ¦‚ç‡ã€‚å¦‚æœå€¼ä¸º 0ï¼Œåˆ™è¡¨ç¤ºä¸ä¼šèµ°ç°åº¦ã€‚å€¼è¶Šå¤§å‘½ä¸­æ¦‚ç‡è¶Šå¤§ã€‚å½“å€¼ = `100` æ—¶ï¼Œä»£è¡¨å…¨èµ°ç°åº¦ã€‚



ä¿å­˜åï¼Œä½¿ç”¨ `kubectl apply` ç”Ÿæ•ˆé…ç½®æ–‡ä»¶ï¼š
```shell
kubectl apply -f ./gray.yaml
```


æˆ‘ä»¬ç”¨shellè„šæœ¬è¯­è¨€å†™ä¸ªè½®è¯¢ï¼Œå¾ªç¯10æ¬¡è°ƒç”¨æœåŠ¡ï¼Œçœ‹ç°åº¦å‘½ä¸­æ¦‚ç‡ï¼š
```shell
for ((i=1; i<=10; i++)); do curl 127.0.0.1:ç«¯å£å€¼;echo; done
```
### ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/841f48ea47db4531af410b5395f94bbc~tplv-k3u1fbpfcp-zoom-1.image)
é€šè¿‡è½®è¯¢10æ¬¡å‘ç°ï¼Œå…¶å‘½ä¸­æ¦‚ç‡å¤§æ¦‚åœ¨ `4-6` æ¬¡å·¦å³ã€‚è¿™ä¸ªå‘½ä¸­æ¦‚ç‡åªæ˜¯ç›¸å¯¹äºå•è¯è¯·æ±‚è€Œè¨€ï¼Œæ‹¥æœ‰50%çš„æ¦‚ç‡ã€‚æ‰€ä»¥æ‰¹é‡æ‰§è¡Œå­˜åœ¨è¯¯å·®æ˜¯æ­£å¸¸çš„ã€‚


### æ³¨æ„äº‹é¡¹ï¼šä¼˜å…ˆçº§


ä¸Šé¢çš„ä¸‰ç§ç°åº¦æ–¹æ¡ˆéƒ½äº†è§£å®Œåï¼Œå¦‚æœåŒæ—¶é…ç½®ä¸‰ç§æ–¹æ¡ˆï¼Œé‚£ä¹ˆä»–ä»¬åœ¨ `ingress` ä¸­çš„ä¼˜å…ˆçº§æ˜¯æ€æ ·çš„ï¼Ÿ
åœ¨å®˜æ–¹æ–‡æ¡£çš„åé¢æœ‰ä¸€ä¸ª `Note` æç¤ºï¼Œä¸Šé¢æ˜ç¡®æœ‰å†™ï¼š
> Canary rules are evaluated in order of precedence. Precedence is as follows:Â 
> **canary-by-header -> canary-by-cookie -> canary-weight**



`k8s` ä¼šä¼˜å…ˆå»åŒ¹é… `header` ï¼Œå¦‚æœæœªåŒ¹é…åˆ™å»åŒ¹é… `cookie` ï¼Œæœ€åæ˜¯ `weight`


## æ€»ç»“


è¿™é‡Œæˆ‘ä»¬å­¦ä¹ äº†ç°åº¦å‘å¸ƒçš„é…ç½®æ–¹å¼å’Œå…¶3ç§æ¨¡å¼ï¼šåŸºäº `cookie` åˆ‡åˆ†ï¼ŒåŸºäº `header` åˆ‡åˆ†ï¼ŒåŸºäºæƒé‡æ¦‚ç‡åˆ‡åˆ†ã€‚


æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šå­¦ä¹ åŸºäº `deployment` çš„æ»šåŠ¨å‘å¸ƒæ¨¡å¼ï¼Œè®²è§£å¦‚ä½•ä¸å®•æœºå¹³æ»‘å‘å¸ƒæœåŠ¡


## å‚è€ƒé“¾æ¥


- kubernetes ingress å®˜æ–¹æ–‡æ¡£ï¼š[https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#canary](https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#canary)





## ä»€ä¹ˆæ˜¯æ»šåŠ¨å‘å¸ƒ


æ»šåŠ¨å‘å¸ƒï¼Œåˆ™æ˜¯æˆ‘ä»¬ä¸€èˆ¬æ‰€è¯´çš„æ— å®•æœºå‘å¸ƒã€‚å…¶å‘å¸ƒæ–¹å¼å¦‚åŒåç§°ä¸€æ ·ï¼Œä¸€æ¬¡å–å‡ºä¸€å°/å¤šå°æœåŠ¡å™¨ï¼ˆçœ‹ç­–ç•¥é…ç½®ï¼‰è¿›è¡Œæ–°ç‰ˆæœ¬æ›´æ–°ã€‚å½“å–å‡ºçš„æœåŠ¡å™¨æ–°ç‰ˆç¡®ä¿æ— é—®é¢˜åï¼Œæ¥ç€é‡‡ç”¨åŒç­‰æ–¹å¼æ›´æ–°åé¢çš„æœåŠ¡å™¨ã€‚


## å‘å¸ƒæµç¨‹å’Œç­–ç•¥


### å°±ç»ªçŠ¶æ€


ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬å‡†å¤‡ä¸€ç»„æœåŠ¡å™¨ã€‚è¿™ç»„æœåŠ¡å™¨å½“å‰æœåŠ¡çš„ç‰ˆæœ¬æ˜¯ V1ã€‚


æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä¼šä½¿ç”¨æ»šåŠ¨ç­–ç•¥ï¼Œå°†å…¶å‘å¸ƒåˆ° V2 ç‰ˆæœ¬ã€‚
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6b82db5b76244f708cf4cbd259bf854a~tplv-k3u1fbpfcp-zoom-1.image)
### å‡çº§ç¬¬ä¸€ä¸ª Pod


ç¬¬äºŒæ­¥å¼€å§‹å‡çº§ã€‚


é¦–å…ˆï¼Œä¼šå¢åŠ ä¸€ä¸ª V2 ç‰ˆæœ¬çš„ Pod1 ä¸Šæ¥ï¼Œ**å°† V1 ç‰ˆæœ¬çš„ Pod1 ä¸‹çº¿ä½†ä¸ç§»é™¤ã€‚æ­¤æ—¶ï¼ŒV1ç‰ˆæœ¬çš„ Pod1 å°†ä¸ä¼šæ¥å—æµé‡è¿›æ¥ï¼Œè€Œæ˜¯è¿›å…¥ä¸€ä¸ªå¹³æ»‘æœŸç­‰å¾…çŠ¶æ€ï¼ˆå¤§çº¦å‡ åç§’ï¼‰åæ‰ä¼šè¢«æ€æ‰ã€‚**

ç¬¬ä¸€ä¸ª Pod å‡çº§å®Œæ¯•
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/91075d4256184ddfb01508d2431e48b5~tplv-k3u1fbpfcp-zoom-1.image)
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/16bdb14d3c6e472a8ae39ac7bb24e3db~tplv-k3u1fbpfcp-zoom-1.image)
### å‡çº§å‰©ä¸‹çš„ Pod


ä¸ä¸ŠåŒç†ï¼ŒåŒæ ·æ˜¯**æ–°å¢æ–°ç‰ˆæœ¬Podåï¼Œå°†æ—§ç‰ˆæœ¬Podä¸‹çº¿è¿›å…¥å¹³æ»‘æœŸä½†ä¸åˆ é™¤ã€‚ç­‰å¹³æ»‘æœŸåº¦è¿‡åå†åˆ é™¤Podï¼š**
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f86ed4f6c02344a8ab1b1854fa372dc0~tplv-k3u1fbpfcp-zoom-1.image)
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2ec1d08fa6ba4e29953372c5148a9426~tplv-k3u1fbpfcp-zoom-1.image)
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/19cb25fe400c4cc2bc053a8a4cec2689~tplv-k3u1fbpfcp-zoom-1.image)
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fa048085bd644b409686878da1d024d5~tplv-k3u1fbpfcp-zoom-1.image)
## ä¼˜ç¼ºç‚¹


æ»šåŠ¨å‘å¸ƒä½œä¸ºä¼—å¤šå‘å¸ƒç±»å‹çš„ä¸€ç§ï¼Œå¿…ç„¶ä¹Ÿå­˜åœ¨ç€ä¸€äº›ä¼˜ç‚¹å’Œç¼ºç‚¹ï¼š


### ä¼˜ç‚¹


1. ä¸éœ€è¦åœæœºæ›´æ–°ï¼Œæ— æ„ŸçŸ¥å¹³æ»‘æ›´æ–°ã€‚
1. ç‰ˆæœ¬æ›´æ–°æˆæœ¬å°ã€‚ä¸éœ€è¦æ–°æ—§ç‰ˆæœ¬å…±å­˜



### ç¼ºç‚¹


1. æ›´æ–°æ—¶é—´é•¿ï¼šæ¯æ¬¡åªæ›´æ–°ä¸€ä¸ª/å¤šä¸ªé•œåƒï¼Œéœ€è¦é¢‘ç¹è¿ç»­ç­‰å¾…æœåŠ¡å¯åŠ¨ç¼“å†²ï¼ˆè¯¦è§ä¸‹æ–¹å¹³æ»‘æœŸä»‹ç»ï¼‰
1. æ—§ç‰ˆæœ¬ç¯å¢ƒæ— æ³•å¾—åˆ°å¤‡ä»½ï¼šå§‹ç»ˆåªæœ‰ä¸€ä¸ªç¯å¢ƒå­˜åœ¨
1. å›æ»šç‰ˆæœ¬å¼‚å¸¸ç—›è‹¦ï¼šå¦‚æœæ»šåŠ¨å‘å¸ƒåˆ°ä¸€åŠå‡ºäº†é—®é¢˜ï¼Œå›æ»šæ—¶éœ€è¦ä½¿ç”¨åŒæ ·çš„æ»šåŠ¨ç­–ç•¥å›æ»šæ—§ç‰ˆæœ¬ã€‚



## Kubernetes ä¸­çš„æ»šåŠ¨å‘å¸ƒ


åœ¨ `Kubernetes` çš„ `ReplicaSet` ä¸­ï¼Œé»˜è®¤å°±æ˜¯æ»šåŠ¨å‘å¸ƒé•œåƒã€‚æˆ‘ä»¬åªéœ€è¦é€šè¿‡ç®€å•çš„é…ç½®å³å¯è°ƒæ•´æ»šåŠ¨å‘å¸ƒç­–ç•¥


ç¼–è¾‘ `deployment` æ–‡ä»¶ï¼š
```shell
vim ./v2.yaml
```


åœ¨å›¾ç¤ºçš„ä½ç½®æ·»åŠ ä»¥ä¸‹å­—æ®µï¼š
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ea59e732f97544568a4e28e302c7943c~tplv-k3u1fbpfcp-zoom-1.image)
```yaml
minReadySeconds: 1
  replicas: 10
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
```


å­—æ®µçš„å«ä¹‰åˆ†åˆ«ä¸ºï¼š

| åç§° | å«ä¹‰ |
| --- | --- |
| minReadySeconds | å®¹å™¨æ¥å—æµé‡å»¶ç¼“æ—¶é—´ï¼šå•ä½ä¸ºç§’ï¼Œé»˜è®¤ä¸º0ã€‚å¦‚æœæ²¡æœ‰è®¾ç½®çš„è¯ï¼Œk8sä¼šè®¤ä¸ºå®¹å™¨å¯åŠ¨æˆåŠŸåå°±å¯ä»¥ç”¨äº†ã€‚è®¾ç½®è¯¥å€¼å¯ä»¥å»¶ç¼“å®¹å™¨æµé‡åˆ‡åˆ† |
| strategy.type =Â RollingUpdate | ReplicaSet å‘å¸ƒç±»å‹ï¼Œå£°æ˜ä¸ºæ»šåŠ¨å‘å¸ƒï¼Œé»˜è®¤ä¹Ÿä¸ºæ»šåŠ¨å‘å¸ƒ |
| strategy.rollingUpdate.maxSurge | æœ€å¤šPodæ•°é‡ï¼šä¸ºæ•°å­—ç±»å‹/ç™¾åˆ†æ¯”ã€‚å¦‚æœ maxSurge è®¾ç½®ä¸º1ï¼Œreplicas è®¾ç½®ä¸º10ï¼Œåˆ™åœ¨å‘å¸ƒè¿‡ç¨‹ä¸­podæ•°é‡æœ€å¤šä¸º10 + 1ä¸ªï¼ˆå¤šå‡ºæ¥çš„ä¸ºæ—§ç‰ˆæœ¬podï¼Œå¹³æ»‘æœŸä¸å¯ç”¨çŠ¶æ€ï¼‰ã€‚maxUnavailable ä¸º 0 æ—¶ï¼Œè¯¥å€¼ä¹Ÿä¸èƒ½è®¾ç½®ä¸º0 |
| strategy.rollingUpdate.maxUnavailable | å‡çº§ä¸­æœ€å¤šä¸å¯ç”¨podçš„æ•°é‡ï¼šä¸ºæ•°å­—ç±»å‹/ç™¾åˆ†æ¯”ã€‚å½“Â maxSurge ä¸º 0 æ—¶ï¼Œè¯¥å€¼ä¹Ÿä¸èƒ½è®¾ç½®ä¸º0ã€‚ |

ç¼–è¾‘ç»“æŸåï¼Œä¿å­˜æ–‡ä»¶ã€‚


æ¥ç€ä½¿`Kubernetes`ç”Ÿæ•ˆé…ç½®ã€‚é…ç½®ç”Ÿæ•ˆåç«‹å³ç»§ç»­å‘å¸ƒåŠ¨ä½œï¼Œéšåç›‘å¬æŸ¥çœ‹å‘å¸ƒçŠ¶æ€æ›´æ”¹ï¼š
```shell
kubectl apply -f ./v2.yaml && kubectl rollout status deployment/front-v2
```
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cb12d03e60ed40fa93cfa97c9ff9cf96~tplv-k3u1fbpfcp-zoom-1.image)


æˆ‘ä»¬é€šè¿‡æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼Œ3ä¸ª `replicas` çš„æ›´æ–°é€»è¾‘é€»è¾‘ä¸ºï¼š**å•ä¸ªé€ä¸ªåœ°å»è¿›è¡Œæ›´æ–° Podã€‚è€Œä¸æ˜¯ä¸€æ¬¡æ€§å°†æ—§çš„Pod å…¨éƒ¨æ€æ­»åï¼Œå†å¯åŠ¨æ–°çš„ Podã€‚**

é€šè¿‡ç®€å•çš„é…ç½®ï¼Œæˆ‘ä»¬å³å¯åœ¨k8sä¸­å®ç°æ»šåŠ¨å‘å¸ƒã€‚


## å¦ä¸€ç§å‘å¸ƒæ¨¡å¼


æ—¢ç„¶ `k8s` çš„é»˜è®¤å‘å¸ƒæ–¹å¼å°±æ˜¯æ»šåŠ¨å‘å¸ƒï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰å…¶ä»–çš„æ›´æ–°æ–¹å¼ï¼Ÿ


åœ¨ `Kubernetes` ä¸­ï¼Œæœ‰ä¸€ç§å‘å¸ƒæ–¹å¼ä¸º `Recreate` ã€‚è¿™ç§å‘å¸ƒæ–¹å¼æ¯”è¾ƒæš´åŠ›ï¼Œå®ƒä¼šç›´æ¥æŠŠæ‰€æœ‰æ—§çš„ `Pod` å…¨éƒ¨æ€æ­»ã€‚æ€æ­»åå†æ‰¹é‡åˆ›å»ºæ–°çš„ `Pod` ã€‚


æˆ‘ä»¬åªéœ€è¦å°†  `strategy.type`Â  æ”¹ä¸º `Recreate` å³å¯ï¼š
```shell
vim ./v2.yaml
# type: Recreate
```


æ¥ç€æ›´æ–° `deployment` å¹¶æŸ¥çœ‹å‘å¸ƒçŠ¶æ€ï¼š
```shell
kubectl apply -f ./v2.yaml && kubectl rollout status deployment/front-v2
```
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a4112d46b9d4409e9e592fc2440111c8~tplv-k3u1fbpfcp-zoom-1.image)
æˆ‘ä»¬çœ‹åˆ°ï¼Œ `k8s` ä¼šå°†æ‰€æœ‰æ—§çš„ `Pod` æ€æ­»ï¼Œéšåå†æ‰¹é‡å¯åŠ¨æ–°çš„ `Pod` ã€‚


è¿™ç§å‘å¸ƒæ–¹å¼ç›¸å¯¹æ»šåŠ¨å‘å¸ƒåæš´åŠ›ã€‚**ä¸”åœ¨å‘å¸ƒç©ºçª—æœŸï¼ˆæ€æ­»æ—§Podï¼Œæ–°Podè¿˜æ²¡åˆ›å»ºæˆåŠŸçš„æƒ…å†µä¸‹ï¼‰æœåŠ¡ä¼šä¸å¯ç”¨ã€‚**




æ¥ç€æˆ‘ä»¬å†æ¥ä»‹ç»ä¸‹ä¸Šé¢æåˆ°çš„ `kubectl rollout` å‘½ä»¤ï¼š


## kubectl rollout


`kubectl rollout` å‘½ä»¤å¯ä»¥ç”¨æ¥æ“çºµ `deployment` çš„èµ„æºè¿›è¡Œç®¡ç†ã€‚åŒ…æ‹¬å¯¹ç‰ˆæœ¬çš„å¿«é€Ÿå›é€€ï¼Œæš‚åœ/æ¢å¤ç‰ˆæœ¬æ›´æ–°ï¼Œæ ¹æ®æ›´æ–°å†å²å›é€€ç‰ˆæœ¬ç­‰åŠŸèƒ½ã€‚


ä¾‹å¦‚æš‚åœä¸€ä¸ª `deployment` çš„å‘å¸ƒï¼š
```shell
kubectl rollout pause deployment/åç§°
```


ç»§ç»­ä¸€ä¸ª `deployment` çš„å‘å¸ƒï¼š
```shell
kubectl rollout resume deployment/åç§°
```


æŸ¥çœ‹ä¸€ä¸ª `deployment` çš„å‘å¸ƒçŠ¶æ€ï¼š
```shell
kubectl rollout status deployment/åç§°
```


## ç»“æŸè¯­


åœ¨è¿™ä¸€ç« ï¼Œæˆ‘ä»¬é€šè¿‡ `Kuberentes`Â å®ç°äº†ç°åº¦å‘å¸ƒ/æ»šåŠ¨å‘å¸ƒç¯å¢ƒï¼ŒåŸºæœ¬ä¸Šå¯ä»¥æ»¡è¶³éœ€æ±‚ã€‚åœ¨ä¸‹ä¸€ç« ï¼Œæˆ‘ä»¬ä¼šç»™å¤§å®¶å¸¦æ¥æ–°ä¸œè¥¿ â€”â€” å¥åº·åº¦æ£€æŸ¥ã€‚å¯ä»¥è®©ä½ æ›´å¥½åœ°ç®¡ç†æœåŠ¡çŠ¶æ€ï¼Œæ§åˆ¶æœåŠ¡çš„è¿è¡Œè¡Œä¸º


å¤§å®¶æœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿæ¬¢è¿åœ¨è¯„è®ºåŒºç•™è¨€å›å¤ ğŸ‘
