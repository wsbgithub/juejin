Node.js ä¸­çš„ `setTimeout()`
-------------------------

ä¸Šä¸€ç« ä¸­ï¼Œæˆ‘ä»¬è®²äº†åœ¨ Node.js ä¸­ï¼Œ`setTimeout()` å‡½æ•°æœ¬è´¨æ˜¯åˆ›å»ºä¸€ä¸ª `Timeout` å®ä¾‹ï¼Œå¹¶å°†å…¶ææˆé“¾è¡¨æ¨å…¥ä¸€ä¸ª `Map` å’Œä¸€ä¸ªä¼˜å…ˆé˜Ÿåˆ—ä¸­ã€‚åœ¨èƒŒåæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå®šæ—¶å™¨æ¥æ¨åŠ¨ libuv å®šæœŸæ¶ˆè´¹è¿™äº›é“¾è¡¨ã€‚

ä½†æ˜¯è®²åˆ°æœ€åï¼Œä¹Ÿå°±è®²äº†è¿™ä¸ªæµç¨‹ï¼Œé‚£ä¹ˆæ‰€è°“çš„ `Timeout` å®ä¾‹åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿåœ¨æ¶ˆè´¹é“¾è¡¨çš„æ—¶å€™ï¼Œå®é™…ä¸Šå‘ç”Ÿäº†ä»€ä¹ˆäº‹å‘¢ï¼Ÿæˆ‘ä»¬ä¸Šä¸€ç« è®²åˆ°äº†æ‰€è°“çš„è–…ç¾Šæ¯›ç®—æ³•ï¼Œæˆ–æ˜¯ç å®åº—ç®—æ³•ï¼Œé‚£ä¹ˆè¿›åˆ°æŸä¸ªç¾Šåœˆæˆ–è€…ç å®åº—åï¼Œåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆå‘¢ï¼Ÿè¿›å…¥ç¾Šåœˆçš„é€»è¾‘å°±æ˜¯åœ¨ä¸Šä¸€ç« ä¸­æœªè¯¦è§£çš„ `listOnTimeout()` å‡½æ•°ä¸­ã€‚

### `listOnTimeout()`

æˆ‘ä»[è¯¥å‡½æ•°çš„æºç ](https://github.com/nodejs/node/blob/v18.14.1/lib/internal/timers.js#L517-L588 "https://github.com/nodejs/node/blob/v18.14.1/lib/internal/timers.js#L517-L588")ä¸­æå–é€»è¾‘ï¼Œä¿ç•™ä¸»è¦é€»è¾‘ä»¥ä¾¿åˆ†æã€‚

      function listOnTimeout(list, now) {
        const msecs = list.msecs;
    
        let ranAtLeastOneTimer = false;
        let timer;
        while ((timer = L.peek(list)) != null) {
          const diff = now - timer._idleStart;
    
          // Check if this loop iteration is too early for the next timer.
          // This happens if there are more timers scheduled for later in the list.
          if (diff < msecs) {
            list.expiry = MathMax(timer._idleStart + msecs, now + 1);
            list.id = timerListId++;
            timerListQueue.percolateDown(1);
            debug('%d list wait because diff is %d', msecs, diff);
            return;
          }
    
          if (ranAtLeastOneTimer)
            runNextTicks();
          else
            ranAtLeastOneTimer = true;
    
          // The actual logic for when a timeout happens.
          L.remove(timer);
    
          ...
    
          let start;
          if (timer._repeat)
            start = getLibuvNow();
    
          try {
            const args = timer._timerArgs;
            if (args === undefined)
              timer._onTimeout();
            else
              ReflectApply(timer._onTimeout, timer, args);
          } finally {
            if (timer._repeat && timer._idleTimeout !== -1) {
              timer._idleTimeout = timer._repeat;
              insert(timer, timer._idleTimeout, start);
            } else if (...) {
              ...
            }
          }
        }
    

ä¸Šé¢å°±æ˜¯æ‰€è°“çš„â€œè¿›å…¥ä¸€ä¸ªç¾Šåœˆï¼ŒæŠŠèƒ½è–…çš„ç¾Šå…¨è–…ä¸€éâ€çš„è¿‡ç¨‹ã€‚`list` å°±æ˜¯ç¾Šåœˆï¼Œ`now` å°±æ˜¯å½“å‰ Tick çš„æ—¶é—´ã€‚é¦–å…ˆå°±æ˜¯ä¸€ä¸ª `while` å»ä¸æ–­ä» `list` ä¸­è·å–é¦–ä¸ªå…ƒç´ ã€‚ä¸Šä¸€ç« æˆ‘ä»¬ä¹Ÿæ€è€ƒè¿‡äº†ï¼Œç”±äºæ—¶é—´ä¸€å¾€æ— å‰çš„ç‰¹æ€§ï¼Œä»»æ„ä¸€ä¸ª `Timeout` çš„é“¾è¡¨å…ƒç´ éƒ½æ˜¯æŒ‰æ—¶åºæ’å…¥çš„ï¼Œæ‰€ä»¥è‚¯å®šæ˜¯è¶Šå‰é¢çš„å…ƒç´ è¶Šæ—©è¿‡æœŸâ€”â€”å³è¿™æ˜¯ä¸€ä¸ªæœ‰åºé“¾è¡¨ã€‚æ‰€ä»¥â€œä¸æ–­ä» `list` ä¸­è·å–é¦–ä¸ªå…ƒç´ â€æ„å‘³ç€æŒ‰æ—¶é—´æ—©æ™šé¡ºåºä»é“¾è¡¨ä¸­æ‹¿åˆ°å¯¹åº”çš„ `Timeout` å®ä¾‹ã€‚

> ä¸Šé¢ä»£ç ä¸­ï¼Œ`L.peek()` å°±æ˜¯ä»ä¸€ä¸ª `list` ä¸­è·å–é¦–ä¸ªå…ƒç´ ã€‚

åœ¨ `while` æ¯æ¬¡å¾ªç¯ä¸­ï¼Œå…ˆåˆ¤æ–­ä¸€ä¸‹æ‹¿åˆ°çš„ `Timeout` å®ä¾‹æ˜¯å¦åº”è¢«è§¦å‘ï¼Œå³æ˜¯å¦è¿‡æœŸã€‚å¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œåˆ™è¿›å…¥ `if` åˆ†æ”¯ã€‚å°†è¯¥ `Timeout` å®ä¾‹å¯¹åº”çš„è¿‡æœŸæ—¶é—´ä½œä¸ºå½“å‰é“¾è¡¨æ•´ä½“çš„è¿‡æœŸæ—¶é—´ï¼Œå¹¶é‡æ’ä¼˜å…ˆé˜Ÿåˆ—ã€‚

> #### IEEE754 çš„å‘
> 
> æˆ‘ä»¬ä¸Šä¸€ç« ä¸­è®²è¿‡ï¼Œé“¾è¡¨çš„ `expiry` ä¸ºè¿™æ¡é“¾è¡¨ `Timeout` æœ€æ—©è¿‡æœŸæ—¶é—´ã€‚æ‰€ä»¥å½“ä¸‹ä¸€ä¸ª `Timeout` æ²¡è¿‡æœŸçš„æ—¶å€™ï¼Œè‡ªç„¶å°±ä¼šæ›´æ–°è¯¥å€¼ä¸ºå¯¹åº” `Timeout` çš„å€¼ï¼Œå³ï¼š
> 
>     list.expiry = MathMax(timer._idleStart + msecs, now + 1);
>     
> 
> å¯èƒ½å¤§å®¶ä¼šå¥½å¥‡ï¼Œä¸ºä»€ä¹ˆ `list.expiry` ä¸ç›´æ¥æ˜¯ `timer._idleStart + msecs`ï¼Œè€Œæ˜¯è¿˜è¦è·Ÿ `now + 1` è¿›è¡Œä¸€æ¬¡æœ€å¤§å€¼æ¯”è¾ƒã€‚**å…¶å®ä¹‹å‰çš„** **Node.js** **çš„ç¡®æ˜¯ç›´æ¥è¿™ä¹ˆå†™çš„ï¼Œä½†è¿™ä¹ˆå†™æœ‰é—®é¢˜ã€‚**
> 
> ä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰æ³¨æ„åˆ°ï¼Œæˆ‘ä¹‹å‰ç»™å¤§å®¶ä»‹ç»è¿™æ•´æ®µé€»è¾‘çš„æ—¶å€™ï¼Œå…¨ç¨‹æ²¡æœ‰æè¿‡å¯¹ `setTimeout()` çš„ç¬¬äºŒä¸ªæ—¶é—´å‚æ•°åšè¿‡å¤„ç†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå¯ä»¥æ˜¯ä¸ªæµ®ç‚¹æ•°ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œ`1.1 * 100` åœ¨ JavaScript å¹¶ä¸æ˜¯ `110`ï¼Œè€Œæ˜¯ `110.00000000000001`ã€‚å°±æ˜¯è¿™ä¹ˆç‚¹ç»†å¾®çš„å·®åˆ«ï¼Œæœ‰å¯èƒ½å¯¼è‡´é—®é¢˜ã€‚
> 
> æ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼š
> 
>     const time = 1.1 * 100;
>     function exec(i) {
>       console.log(i);
>       setTimeout(exec, time, ++i);
>     }
>     exec(0);
>     
> 
> æˆ‘ä»¬èƒ½çœ‹åˆ°è¿™æ˜¯ä¸€ä¸ªä¸€ç›´ `setTimeout(110.00000000000001)` çš„ä¾‹å­ã€‚å¦‚æœå½“å‰æ—¶é—´æ˜¯ `18`ï¼Œé‚£ä¹ˆè¶…æ—¶æ—¶é—´ç†è®ºä¸Šæ˜¯ `18 + 110.00000000000001` ï¼Œå³ `128.00000000000001`ã€‚å®é™…ä¸Šå‘¢ï¼Ÿå¤§å®¶ä¸å¦¨å¯ä»¥æ‰“å¼€ Chrome çš„æ§åˆ¶å°æˆ–è€… Node.js æµ‹è¯•ä¸€ä¸‹ï¼š
> 
> ![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e3677d226db543baa94cb0e702795201~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=896&h=504&s=38782&e=png&a=1&b=ffffff)
> 
> çœ‹å§ï¼å˜æˆæ•´æ•°äº†ï¼æ˜¾ç„¶ JavaScript çš„ IEEE754 æµ®ç‚¹æ•°å¹¶ä¸é è°±ã€‚ä½†æ˜¯ä½œä¸º Node.js è¿è¡Œæ—¶ï¼Œæ˜¾ç„¶ä¸èƒ½è¢«è¿™ç§ä¸é è°±å‘äº†ã€‚æˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ï¼Œå¦‚æœè¿˜æ˜¯ Node.js ä¹‹å‰çš„é€»è¾‘ï¼Œé‚£ä¹ˆ `list.expiry` ä¼šè¢«è®¾ç½®ä¸º `128`ã€‚å¦‚æœå½“å‰æ—¶é—´æ°å¥½æ˜¯ `128`ï¼Œåœ¨ `processTimer()` çš„æ—¶å€™ä¼šå¾ªç¯è¿›è¯¥é“¾è¡¨è®¤ä¸ºå®ƒâ€œè¿‡æœŸâ€äº†ã€‚ä½†æ˜¯è¿›äº†é“¾è¡¨ `listOnTimer()` åï¼Œ`diff = now - timer._idleStart` ä¸º `128 - 18`ï¼Œå³ `diff` ä¸º `110`ã€‚é‚£è¿™ä¸ªæ—¶å€™ `diff < mses` æ˜¾ç„¶æ˜¯æˆç«‹çš„ï¼ˆæ¯•ç«Ÿ `110 < 110.00000000000001`ï¼‰ï¼Œä¼šè¢«è®¤ä¸ºâ€œæ²¡è¿‡æœŸâ€ã€‚
> 
> å¤–å±‚è®¤ä¸ºâ€œè¿‡æœŸäº†â€ï¼Œå†…å±‚è®¤ä¸ºâ€œæ²¡è¿‡æœŸâ€ã€‚é‚£ä¹ˆå°† `list.expiry` åŸå°ä¸åŠ¨åœ°è®¾ç½®ä¸ºè¯¥ `Timeout` çš„è¿‡æœŸæ—¶é—´çš„è¯ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿé€€å‡ºè¯¥å±‚ `listOnTimer` åï¼Œåœ¨ `processTimer` çš„ä¸‹ä¸€æ¬¡å¾ªç¯ä»ç„¶ä¼šæ‹¿åˆ°è¿™ä¸ª `list`ï¼Œæ‹¿åˆ°åå†åˆ¤æ–­ä»ç„¶ä¼šè®¤ä¸ºå…¶â€œè¿‡æœŸäº†â€ã€‚ç„¶åå†è¿›å»ï¼Œç„¶åâ€¦â€¦ğŸ¤¡ æ­»å¾ªç¯äº†ï¼
> 
> è¿™å°±ç›¸å½“äºè–…ç¾Šæ¯›æ—¶å€™ï¼Œåœ¨å¤–é¢çœ‹ç¾Šæ¯›é•¿å¥½äº†ï¼Œè¿›å»ä¸€çœ‹å‘ç°æ˜¯è„ä¸œè¥¿ã€‚å†å‡ºå»çœ‹ï¼Œå¥½åƒç¾Šæ¯›é•¿å¥½äº†ï¼Œè¿›å»ä¸€çœ‹åˆæ˜¯è„ä¸œè¥¿â€¦â€¦
> 
> äºæ˜¯ï¼Œä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼ŒNode.js å°±æ‰‹åŠ¨å¾€è¿™ä¸ªè¶…æ—¶æ—¶é—´ä¸ŠåŠ ä¸ªä¸€ï¼Œåæ­£ä¸€æ¯«ç§’å·¦å³çš„è¯¯å·®å¾ˆæ­£å¸¸ã€‚å³ä½¿æ˜¯ Node.js æ­£å¸¸åœ¨è·‘ï¼Œ`setTimeout()` æœ¬èº«ä¹Ÿå°±æ²¡æœ‰é‚£ä¸ªç²¾ç¡®åº¦ã€‚

ä¸Šé¢ä»£ç ä¸­ `timerListQueue.percolateDown(1)` çš„æ„æ€æ˜¯ï¼Œå¯¹ä¼˜å…ˆé˜Ÿåˆ—ç¬¬ä¸€ä¸ªå…ƒç´ è¿›è¡Œä¸‹æ»¤æ“ä½œã€‚æ¯•ç«Ÿè¿™ä¸ªæ—¶å€™å®ƒçš„ `expiry` è¢«ä¿®æ”¹äº†ï¼Œä¸ä¸€å®šæ˜¯æœ€æ—©è¿‡æœŸçš„é“¾è¡¨äº†ï¼Œéœ€è¦ä¸‹æ»¤ä»¥å¾—åˆ°æ–°çš„æœ€æ—©é“¾è¡¨ã€‚ä¸‹æ»¤è¿‡åï¼Œé€€å‡ºè¯¥å‡½æ•°ï¼Œå›åˆ°ä¹‹å‰çš„ `processTimers()`ï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªå¾ªç¯ï¼Œå³å†æ‹¿å‡ºæ–°çš„æœ€æ—©è¿‡æœŸé“¾è¡¨ï¼Œå¹¶åˆ¤æ–­æœ‰æ²¡æœ‰è¿‡æœŸï¼Œç„¶ååšåç»­é€»è¾‘â€¦â€¦è¿™å°±æ˜¯è–…ç¾Šæ¯›è–…åˆ°æ²¡æœ‰å¯è–…ä¹‹åçš„æµç¨‹ã€‚

ä½†è‹¥é“¾è¡¨ä¸­å½“å‰ `Timeout` å·²è¿‡æœŸï¼Œåˆ™æ˜¯åé¢çš„é€»è¾‘äº†ã€‚å…ˆè¿˜æ˜¯æ¨¡æ‹Ÿä¸€æ¬¡ Tickï¼Œå°±å¦‚ `processTimers()` é‡Œé¢é‚£æ ·ï¼š

    if (ranAtLeastOneTimer)
      runNextTicks();
    else
      ranAtLeastOneTimer = true;
    

ç„¶åå°†è¯¥ `Timeout` ä»é“¾è¡¨ä¸­ç§»é™¤ã€‚æ¥ä¸‹å»çš„æ•´ä½“é€»è¾‘å°±æ˜¯å»æ‰§è¡Œ `Timeout` çš„ `_onTimeout()` æ–¹æ³•ï¼Œé‡Œé¢å°±æ˜¯å»æ‰§è¡Œç”¨æˆ·ä¾§ä¼ å…¥ `setTimeout()` çš„ç¬¬ä¸€ä¸ªå‚æ•° `callback`ï¼Œè¿™å°±æ˜¯ `setTimeout()` é€»è¾‘çš„æœ€ç»ˆå½’å®¿äº†ï¼Œæ¯•ç«Ÿå®ƒçš„ç”¨å¤„å°±æ˜¯åœ¨å¤šå°‘æ—¶é—´åå»æ‰§è¡Œç¬¬ä¸€ä¸ªå‚æ•° `callback`ã€‚å†ä¹‹åå°±æ˜¯ `setInterval()` é€»è¾‘ï¼ˆ`timer._repeat`ï¼‰äº†ï¼Œå¦‚æœæ˜¯ Repeat çš„ï¼Œåˆ™å°† `Timeout` æ”¹æœŸå¹¶é€šè¿‡ `insert()` é‡æ–°æ’å…¥é“¾è¡¨ã€æ›´æ–° `Map` å’Œä¼˜å…ˆé˜Ÿåˆ—ã€‚

å°† `processTimers()` å’Œ `listOnTimeout` è”ç«‹èµ·æ¥ï¼Œå»æ‰ä¸€äº›è¾¹è§’æ–™é€»è¾‘ï¼Œå®ƒçš„æµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5ddf478d4d764a72ba6f7788dd827528~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=1473&h=1073&s=133411&e=png&a=1&b=ffffff)

### `Timeout`

ä¸Šä¸€ç« ï¼Œä»¥åŠæœ¬ç« å‰æ–‡ä¸­ï¼Œæˆ‘ä»¬æäº†å¤ªå¤šæ¬¡çš„ `Timeout` äº†ã€‚å‡¡æµç¨‹ä¸­ï¼Œå¿…å‡ºç° `Timeout`ã€‚è¿™åˆ°åº•æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Ÿå®ƒæ˜¯ `setTimeout()`ã€`setInterval()` çš„æœ€ç»ˆå½’å®¿ï¼Œå­˜å‚¨äº†å®šæ—¶å™¨çš„ä¸€äº›å…ƒæ•°æ®ï¼Œå¦‚èµ·å§‹æ—¶é—´ã€è¿‡æœŸé—´éš”ã€è¿‡æœŸå›è°ƒå‡½æ•°ç­‰ã€‚

    class Timeout {
      constructor(callback, after, args, isRepeat, isRefed) {
        after *= 1; // Coalesce to number or NaN
        if (!(after >= 1 && after <= TIMEOUT_MAX)) {
          if (after > TIMEOUT_MAX) {
            process.emitWarning(`${after} does not fit into` +
                                ' a 32-bit signed integer.' +
                                '\nTimeout duration was set to 1.',
                                'TimeoutOverflowWarning');
          }
          after = 1; // Schedule on next tick, follows browser behavior
        }
    
        this._idleTimeout = after;
        this._idlePrev = this;
        this._idleNext = this;
        this._idleStart = null;
        // This must be set to null first to avoid function tracking
        // on the hidden class, revisit in V8 versions after 6.2
        this._onTimeout = null;
        this._onTimeout = callback;
        this._timerArgs = args;
        this._repeat = isRepeat ? after : null;
        this._destroyed = false;
    
        if (isRefed)
          incRefCount();
        this[kRefed] = isRefed;
    
        ...
      }
    }
    

æœ€å¼€å§‹æ˜¯åˆ¤æ–­è¿‡æœŸé—´éš”çš„åˆæ³•æ€§ï¼Œå¦‚æœæ—¶é—´ä¸åˆæ³•ï¼Œåˆ™å¼ºè¡Œå°†æ—¶é—´æ”¹ä¸º `1`ã€‚ç„¶åå°±æ˜¯å°†å„ç§å…ƒæ•°æ®ä¿¡æ¯æ”¾åˆ°æˆå‘˜å˜é‡ä¸­ã€‚è¿™ä¸ª `_onTimeout`ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå°±æ˜¯ `setTimeout()` æ—¶å€™ä¼ è¿›æ¥çš„å›è°ƒå‡½æ•°ã€‚æ˜¯ä¸æ˜¯å°±èƒ½è·Ÿä¸Šé¢çš„ `listOnTimeout()` ä¸²è”èµ·æ¥äº†ï¼Ÿ

ä¸Šé¢çš„ `isRepeat` å³è¯¥ `Timeout` æ˜¯å¦é‡å¤æ‰§è¡Œã€‚åœ¨ä¸Šä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° `setTimeout()` å°†è¯¥å€¼è®¾ç½®ä¸º `false`ï¼Œå³ä¸é‡å¤ã€‚è€Œ `setInterval()` çš„ä»£ç ä¸ `setTimeout()` å‡ ä¹ä¸€æ ·ï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯è¯¥å‚æ•°ä½ä¼ çš„æ˜¯ `true`ã€‚

### `timeout.ref()` ä¸ `timeout.unref()`

è¿˜è®°å¾—æˆ‘ä»¬åœ¨ä¸Šä¸€ç« ç•™äº†ä¸€æ‰‹æ²¡æœ‰è§£é‡Šçš„å†…å®¹å—ï¼Ÿ`uv_ref` å’Œ `uv_unref`ã€‚æœ‰å…´è¶£çš„è¯»è€…å¯è¿”å›å»æœä¸€ä¸‹è¿™ä¸ªå…³é”®å­—ï¼Œä»¥åŠ `timeoutInfo[0]`ã€‚

å…ˆæ¥çœ‹æ–‡æ¡£ï¼š

> When called, requests that the Node.js event loop _not_ exit so long as the `Timeout` is active. Calling `timeout.ref()` multiple times will have no effect.
> 
> By default, all `Timeout` objects are "ref'ed", making it normally unnecessary to call `timeout.ref()` unless `timeout.unref()` had been called previously.

å°±æ˜¯è¯´ï¼Œå¦‚æœ `Timeout` æœ‰è¢«â€œå¼•ç”¨â€ï¼Œåˆ™åœ¨æ²¡æœ‰å…¶ä»–è®©äº‹ä»¶å¾ªç¯â€œé•¿å­˜â€çš„æ¡ä»¶ä¸‹ï¼ˆå¦‚æ–‡ä»¶ I/O ç­‰å¾…ã€ç½‘ç»œäº‹ä»¶ç­‰å¾…ç­‰ï¼‰ï¼ŒNode.js çš„æ‰§è¡Œç”Ÿå‘½å‘¨æœŸä¼šè¢« `Timeout` æ’‘ç€ã€‚å¦åˆ™ï¼Œè‹¥æ²¡æœ‰å…¶ä»–â€œé•¿å­˜â€æ¡ä»¶ï¼ŒNode.js ä¼šæ‰§è¡Œå®Œå½“å‰ Tick åï¼Œé©¬ä¸Šé€€å‡ºï¼Œå¹¶ä¸ä¼šç­‰ `Timeout` æ‰§è¡Œã€‚

ä¸¾ä¸ªæœ€ç®€å•ä¾‹å­ï¼š

    console.log('start');
    const timer = setTimeout(() => {
      console.log('done');
    }, 100);
    

è¿™æ®µä»£ç ç”¨ Node.js è·‘ï¼Œä¼šå…ˆè¾“å‡º `start`ï¼Œç„¶ååœ¨ 100 æ¯«ç§’ä¹‹åï¼Œè¾“å‡º `done`ï¼Œç„¶å Node.js é€€å‡ºã€‚å¦‚æœåœ¨ç¬¬å››è¡Œæ’å…¥ï¼š`timer.unref()`ï¼Œåˆ™ Node.js ä¼šåœ¨è¾“å‡º `start` åï¼Œåˆ›å»º `Timeout`ï¼Œç„¶åç›´æ¥é€€å‡ºã€‚

åœ¨ libuv ä¸­ï¼Œå°±æœ‰ `uv_ref()` å’Œ `uv_unref()` çš„æ¦‚å¿µã€‚å¦‚æœ libuv ä¸­ï¼Œä¸å­˜åœ¨ä»»ä½•è¢« Reference çš„å¥æŸ„ï¼Œå°±ä¼šé€€å‡ºäº‹ä»¶å¾ªç¯ã€‚æ‰€ä»¥ `uv_ref()` æ˜¯ä¸ºäº†æ’‘èµ·å…¶ç”Ÿå‘½å‘¨æœŸç”¨çš„ã€‚

Node.js ä¸­ï¼Œç”¨äº†ä¸€ç§éå¸¸è§„çš„æ–¹å¼ï¼Œæ¥åšé‚£ä¸ªå”¯ä¸€çš„ C++ ä¾§å®šæ—¶å™¨çš„ Reference ä¸ Unreferenceã€‚é¦–å…ˆï¼Œåœ¨ Node.js çš„ `Environment` ä¸­ï¼Œæœ‰ä¸€ä¸ª `timeout_info_` çš„ `Int32Array` çš„ JavaScript `TypedArray`ã€‚è¯´æ˜¯æ•°ç»„ï¼Œå®é™…ä¸Šå®ƒå°±ä¸€ä¸ªå…ƒç´ ï¼Œ`timeout_info_[0]`ã€‚å¦‚æœæˆ‘ä»¬ç›´æ¥ç”¨ä¸€ä¸ª `Number` ç±»å‹ï¼Œé‚£ä¹ˆåœ¨è·å–å®ƒã€æ›´æ”¹å®ƒçš„æ—¶å€™ï¼Œè¦åœ¨ JavaScript ä¸ C++ ä¾§åå¤æ¨ªè·³ï¼Œè¿™æ˜¯æœ‰å¼€é”€çš„ã€‚è€Œæ ¹æ® V8 çš„ç‰¹æ€§ï¼ŒC++ ä¾§æ˜¯å¯ä»¥ç›´æ¥è®¿é—® `Int32Array` æŒ‡å®šä¸‹æ ‡çš„å†…å®¹ï¼Œè·å–çš„æ˜¯åŸç”Ÿ 4 å­—èŠ‚çš„æ•´å‹å†…å­˜ï¼Œè€Œ JavaScript ä¾§ä¹Ÿå¯ä»¥ç›´æ¥æ“ä½œè¯¥æ•°ç»„ã€‚è¿™ä¹ˆä¸€æ¥ï¼ŒåŒæ–¹å¯¹å…¶ç¬¬ `0` ä¸ªå…ƒç´ è¯»å–å’Œæ“ä½œéƒ½å¯ç›´æ¥è¿›è¡Œï¼Œè€Œä¸ç”¨åˆ‡æ¢ä¸Šä¸‹æ–‡ï¼Œå°‘äº†äº›å¼€é”€ã€‚

æ‰€ä»¥ï¼Œè™½ç„¶å®ƒæ˜¯ä¸ª `Int32Array`ï¼Œä½† Node.js å´ Trick åœ°å°†å…¶å½“ä½œæ¨ªè·³ C++ ä¾§ä¸ JavaScript ä¾§çš„ä¸€ä¸ª `Number` å€¼ã€‚ç®€è€Œè¨€ä¹‹ï¼Œä½ å°±ç®€å•ç²—æš´åœ°å½“ `timeoutInfo[0]` æ˜¯ä¸€ä¸ª `Number` å€¼ç”¨å°±å¥½äº†ã€‚

è¿™ä¸ªå€¼çš„ç”¨å¤„æ˜¯ï¼Œè®°å½•æ‰€æœ‰ `Timeout` å®ä¾‹çš„ Reference ä¸ Unreference ç´¯åŠ çš„å€¼ã€‚å½“è¯¥å€¼ä¸º `0` çš„æ—¶å€™ï¼Œè¯´æ˜ä¸å†æœ‰ JavaScript ä¾§çš„ `Timeout` éœ€è¦è¢« Referenceï¼Œé‚£ä¹ˆ `Environment` ä¸­é‚£ä¸ªå”¯ä¸€çš„å®šæ—¶å™¨å¯è¢« `uv_unref()`ï¼›å¦åˆ™å°±è¯´æ˜è¿˜æœ‰è‡³å°‘ä¸€ä¸ª `Timeout` è¢« Referenceï¼Œç”Ÿå‘½å‘¨æœŸéœ€ç»§ç»­è‹¦æ’‘ç€ã€‚

åœ¨ `Timeout` çš„æ„é€ å‡½æ•°ä¸­ï¼Œæœ€åä¸€ä¸ªå‚æ•°æ˜¯ `isRefed`ã€‚`setTimeout()` ä¸ `setInterval()` ä¸­ä¼ çš„éƒ½æ˜¯ `true`ã€‚

æˆ‘ä»¬çœ‹ä¸Šé¢çš„æ„é€ å‡½æ•°ä»£ç ï¼Œå¦‚æœ `isRefed` ä¸º `true`ï¼Œä¼šå¢åŠ  Reference çš„å€¼ï¼ˆ`incRefCount`ï¼‰ã€‚

    function incRefCount() {
      if (timeoutInfo[0]++ === 0)
        toggleTimerRef(true);
    }
    

è¿™é‡Œé¢åšçš„äº‹æƒ…å°±æ˜¯ï¼Œå°† `timeoutInfo[0]` åŠ ä¸€ã€‚è‹¥åŠ ä¸€å‰å…¶å€¼ä¸º `0`ï¼Œæ„å‘³ç€ä¹‹å‰æ²¡æœ‰ä¸€ä¸ªè¢« Reference çš„ `Timeout`ï¼Œæ‰€ä»¥ä»æ— åˆ°æœ‰ï¼Œæˆ‘ä»¬éœ€è¦å» C++ ä¾§å°†å”¯ä¸€çš„å®šæ—¶å™¨ç»™ Referenceï¼ˆ`toggleTimerRef(true)`ï¼‰ã€‚

æ ¹æ®ä¸Šé¢çš„ä»£ç ï¼Œæ˜“å¾— `decRefCount()` çš„ä»£ç ï¼š

    function decRefCount() {
      if (--timeoutInfo[0] === 0)
        toggleTimerRef(false);
    }
    

å¯¹äºä¸€ä¸ª `Timeout` çš„ `ref` å’Œ `unref` å‡½æ•°ï¼Œå®é™…ä¸Šå°±æ˜¯[è°ƒç”¨ä¸Šé¢è¿™ä¸¤ä¸ªå‡½æ•°](https://github.com/nodejs/node/blob/v18.14.1/lib/internal/timers.js#L221-L237 "https://github.com/nodejs/node/blob/v18.14.1/lib/internal/timers.js#L221-L237")ï¼Œåªä¸è¿‡å¤šäº†ä¸€äº›é¢å¤–çš„åˆ¤æ–­å’Œé€»è¾‘è€Œå·²ã€‚

è€Œåœ¨ C++ ä¾§çš„ `toggleTimerRef()` å‡½æ•°ï¼Œå®ƒæ˜¯è°ƒç”¨ `uv_ref()` å’Œ `uv_unref()` æ¥è¾¾åˆ°æœ€ç»ˆç›®çš„ã€‚

    void Environment::ToggleTimerRef(bool ref) {
      if (started_cleanup_) return;
    
      if (ref) {
        uv_ref(reinterpret_cast<uv_handle_t*>(timer_handle()));
      } else {
        uv_unref(reinterpret_cast<uv_handle_t*>(timer_handle()));
      }
    }
    

è¿™æ˜¯å¯¹äºæ–°å»º `Timeout`ã€å¯¹ `Timeout` è¿›è¡Œ `ref()` å’Œ `unref()` æ“ä½œçš„æµç¨‹ï¼Œè¿™éƒ½æ˜¯è‡ªç„¶å¢åˆ è¿‡ç¨‹ã€‚è€Œåœ¨å®šæ—¶å™¨è‡ªç„¶æ¶ˆè€—ï¼ˆé€ä¸ªè¿‡æœŸï¼‰çš„è¿‡ç¨‹æ¥è¯´ï¼Œä¸€æ ·ä¹Ÿæ˜¯éœ€è¦å¯¹å…¶è¿›è¡Œä¸€å®šçš„ `unref()` æ“ä½œçš„ã€‚

æˆ‘ä»¬å›åˆ°ä¸Šä¸€ç« è®²çš„ `processTimers()` å‡½æ•°ï¼Œæˆ‘ä»¬æ›¾ç»è®²è¿‡ `nextExpiry` çš„æ­£è´Ÿé—®é¢˜ï¼š**è¿™ä¸ªäº‹æƒ…ä¸åœ¨ä¸»å¹²ä¸Šï¼Œä¸é‡è¦ï¼Œæš‚ä¸”ä¸æ**ã€‚ä¸è¿‡ä¹Ÿè¿˜æ˜¯æäº†ä¸€å˜´ï¼Œå®é™…ä¸Šåœ¨ C++ ä¾§çš„ `RunTimers()` ä¸­å§‹ç»ˆç”¨çš„æ˜¯è¯¥å€¼çš„ç»å¯¹å€¼ï¼Œæ‰€ä»¥æ­£è´Ÿåªæ˜¯ä¸€ä¸ªç®€æ˜“çš„åˆ¤æ–­æ ‡è¯†ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦å¯¹ libuv è¿›è¡Œ Reference æˆ–è€… Unreference æ“ä½œã€‚

    if (list.expiry > now) {
      nextExpiry = list.expiry;
      return timeoutInfo[0] > 0 ? nextExpiry : -nextExpiry;
    }
    

ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå½“æˆ‘ä»¬é“¾è¡¨è·‘å®Œäº†ï¼Œå‰©ä¸‹çš„éƒ½æ˜¯æ²¡è¿‡æœŸçš„ `Timeout`ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦å‘ŠçŸ¥ C++ ä¾§ä¸‹ä¸€æ¬¡çš„è¿‡æœŸæ—¶é—´ï¼Œä»¥ä¾¿å…¶é‡è®¾å®šæ—¶å™¨ã€‚ç”±äºæˆ‘ä»¬è·‘å®Œäº†ä¸€å †çš„ `Timeout`ï¼Œè·‘å®Œçš„ `Timeout` è‡ªç„¶å°† `timeoutInfo[0]` çš„å€¼æ’é™¤è‡ªèº«ï¼Œè¿™ä¸ªæ—¶å€™è¦çœ‹å‰©ä¸‹çš„ `timeoutInfo[0]` çš„å€¼æ˜¯å¦è¿˜å­˜åœ¨è‡³å°‘ä¸€ä¸ªè¢« Reference çš„ `Timeout`ã€‚è‹¥å­˜åœ¨ï¼Œåˆ™è¿”å›æ­£çš„ `nextExpiry`ï¼›å¦åˆ™è¿”å›è´Ÿå€¼ã€‚

çœ‹çœ‹ C++ ä¾§æ€ä¹ˆç”¨è¿™ä¸ªè¿”å›å€¼å§ã€‚

      if (expiry_ms != 0) {
        int64_t duration_ms =
            llabs(expiry_ms) - (uv_now(env->event_loop()) - env->timer_base());
    
        env->ScheduleTimer(duration_ms > 0 ? duration_ms : 1);
    
        if (expiry_ms > 0)
          uv_ref(h);
        else
          uv_unref(h);
      } else {
        uv_unref(h);
      }
    

åœ¨ç”¨çš„æ—¶å€™ï¼Œé€šè¿‡ `llabs()` å¯¹è¿™ä¸ªè¿”å›å€¼å–ç»å¯¹å€¼ã€‚ä¹Ÿå°±æ˜¯è¯´ç”¨è¿‡æœŸå€¼çš„æ—¶å€™ï¼Œæ€»ç”¨å…¶ç»å¯¹å€¼ï¼ˆå³çœŸå®è¿‡æœŸæ—¶é—´ï¼‰ã€‚è€Œæ­£è´Ÿç¬¦å·åˆ™ç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦ `uv_ref()` æˆ– `uv_unref()`ã€‚å¦‚æœè¿”å›å€¼æ˜¯ `0`ï¼Œåˆ™æ„å‘³ç€æ²¡æœ‰æ›´å¤š `Timeout` äº†ï¼Œé‚£ä¹ˆç›´æ¥ `uv_unref()`ã€‚

åœ¨å‰é¢çš„ `listOnTimeout()` å‡½æ•°ä¸­ï¼Œæˆ‘çœç•¥äº†æ‰§è¡Œ `timer._onTimeout()` ä¹‹åï¼Œåˆ¤æ–­å…¶æ˜¯å¦è¢« Reference çš„é€»è¾‘ã€‚è‹¥å…¶è¢« Referenceï¼Œåˆ™æ‰§è¡Œå®Œåï¼Œ[ä¼šå°† timeoutInfo\[0\] å‡ä¸€](https://github.com/nodejs/node/blob/v18.14.1/lib/internal/timers.js#L579-L580 "https://github.com/nodejs/node/blob/v18.14.1/lib/internal/timers.js#L579-L580")ã€‚

### å°æ’æ›²ï¼šæ—¶åºé—®é¢˜å¯ä»¥æ€ä¹ˆè§£ï¼Ÿ

æˆ‘ä»¬åœ¨ä¸Šä¸€ç« ä¸­è¿˜ç•™äº†ä¸ªé—®é¢˜ä»£ç ã€‚

    'use strict';
    
    setTimeout(() => {
      console.log(1);
    }, 10);
    setTimeout(() => {
      console.log(2);
    }, 15);
    let now = Date.now();
    while (Date.now() - now < 100) {
      //
    }
    setTimeout(() => {
      console.log(3);
    }, 10);
    now = Date.now();
    while (Date.now() - now < 100) {
      //
    }
    

åœ¨å½“å‰ Node.js ç‰ˆæœ¬ï¼ˆå¦‚ v18.14.1ï¼‰ä¸­ï¼Œä¸Šé¢è¿™ä¸ªé—®é¢˜ä»£ç çš„ç»“æœæ˜¯ `1`ã€`3`ã€`2`ã€‚åŸå› ä¹Ÿè§£é‡Šè¿‡äº†ï¼Œè–…ç¾Šæ¯›è–…åˆ°ç§ƒå™œçš®ã€‚ç”¨é¡ºåºç®­å¤´å›¾å±•ç¤ºï¼Œå¦‚ä¸‹ï¼š

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5f3cf575f9b54e1fbca1ba6355746c03~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=653&h=493&s=31813&e=png&a=1&b=ffffff)

ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿‡æœŸæ—¶åˆ»ä¸º `205` çš„ `Timeout` å±…ç„¶æ¯” `35` çš„æ—©æ‰§è¡Œã€‚è¿™æ˜¾ç„¶ä¸åˆç†ã€‚åˆç†çš„é¡ºåºç®­å¤´å›¾åº”è¯¥å¦‚ä¸‹ï¼š

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/89040989b3cc4e16a1b155deb847c426~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=663&h=473&s=32632&e=png&a=1&b=fefefe)

å‰è€…æ˜¯**è–…ç¾Šæ¯›è–…åˆ°æ­»**ï¼Œåè€…æ˜¯**åå¤æ¨ªè·³**ã€‚å‡è®¾ä½ æ˜¯ä¸€ä¸ª Node.js çš„è´¡çŒ®è€…ï¼Œæƒ³æƒ³æˆ‘ä»¬ä¹‹å‰è®²è§£çš„ `processTimers()` å’Œ `listOnTimeout()`ï¼Œå…ˆä¸è®ºæ€§èƒ½å¦‚ä½•ï¼Œæˆ‘ä»¬å¯ä»¥æ€ä¹ˆæ”¹è®©å…¶æ¢å¤é€»è¾‘æ­£å¸¸ï¼Ÿ

![9150e4e5gy1g63ilh1p83g203c03naa2.gif](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b5ec571a016b4495b9f73779bd80da50~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=120&h=131&s=10526&e=gif&f=4&b=fcfafa)

> æ¯•ç«Ÿç”±è–…åˆ°æ­»å˜æˆåå¤æ¨ªè·³ï¼Œåˆ‡æ¢å’Œæ€§èƒ½è‚¯å®šæ˜¯æœ‰é¢å¤–å¼€é”€çš„ï¼Œæ€§èƒ½è‚¯å®šä¼šåŠ£åŒ–ã€‚

å…¶å®åšè¿™ä¸ªæ”¹é€ ï¼Œåœ¨é€»è¾‘ä¸Šçš„æ–¹æ¡ˆå¾ˆç®€å•ï¼š

1.  åœ¨æ¯æ¬¡ `listOnTimeout()` æœ€å¼€å§‹ï¼Œéƒ½å…ˆè·å–ç¬¬äºŒè¶…æ—¶çš„é“¾è¡¨ï¼›
2.  åœ¨ `listOnTimeout()` å¾ªç¯ä¸­ï¼Œæ¯æ¬¡ `Timeout` é™¤äº†åˆ¤æ–­æ˜¯å¦æ²¡è¿‡æœŸï¼Œå†é¢å¤–åˆ¤æ–­ä¸€ä¸‹ä¸ç¬¬äºŒè¶…æ—¶é“¾è¡¨è°ä¼šå…ˆåˆ°æœŸï¼Œè‹¥æ˜¯ç¬¬äºŒé“¾è¡¨å…ˆåˆ°æœŸï¼Œåˆ™é‡æ’ä¼˜å…ˆé˜Ÿåˆ—åé€€å‡º `listOnTimeout()`ã€‚

å°±è¿™ä¸¤æ­¥ï¼Œå°±å¯ä»¥å°†ä¸Šé¢ç¬¬ä¸€å¼ å›¾å˜æˆç¬¬äºŒå¼ å›¾äº†ã€‚æ¯”å¦‚ç¬¬äºŒå¼ å›¾ä¸­ï¼Œ`10ms` çš„ `21` æ‰§è¡Œå®Œäº†ï¼Œæ¥ä¸‹å»æ˜¯ `205`ï¼Œè¿™ä¸ªæ—¶å€™ `205` ä¸ç¬¬äºŒé“¾è¡¨è¿‡æœŸæ—¶é—´ `35` æ¯”è¾ƒã€‚å‘ç°æ¯”ä¸è¿‡ï¼Œå°±æ›´æ–°é“¾è¡¨è¿‡æœŸæ—¶é—´ä¸º `205`ï¼Œé‡æ’ä¼˜å…ˆé˜Ÿåˆ—ï¼Œè¿™ä¸ªæ—¶å€™ `20ms` å°±è·‘ç¬¬ä¸€ä½æ¥äº†ï¼Œæ¥ä¸‹å»å°±æ‰§è¡Œ `20ms` çš„ç¬¬ä¸€ä¸ªå…ƒç´  `35`ï¼Œç„¶å `67` æ—¶å€™å‘ç°æ¯”ä¸è¿‡ `30ms` çš„ `36`ï¼Œä»¥æ­¤ç±»æ¨â€¦â€¦æœ€ç»ˆè¾¾æˆäº† `10ms`â†’`20ms`â†’`30ms`â†’`20ms`â†’`10ms` çš„åå¤æ¨ªè·³ã€‚

ç°åœ¨çš„é—®é¢˜åœ¨äºï¼Œå¦‚ä½•è·å–ç¬¬äºŒè¶…æ—¶çš„é“¾è¡¨å‘¢ï¼Ÿä¼˜å…ˆé˜Ÿåˆ—çš„æœ¬è´¨æ˜¯ä¸€ä¸ªäºŒå‰å †ï¼Œæˆ‘ä»¬åªèƒ½ä¿è¯å †é¡¶å…ƒç´ æ˜¯æœ€å°çš„ã€‚é‚£ç¬¬äºŒå°çš„æ€ä¹ˆè·å–ï¼Ÿ

æˆ‘ä»¬çœ‹çœ‹ä»¥æœ€å°å€¼ä¸ºä¼˜å…ˆçš„ä¼˜å…ˆé˜Ÿåˆ—çš„äºŒå‰å †æ˜¯æŒ‰ä»€ä¹ˆè§„åˆ™æ’åˆ—çš„ï¼šçˆ¶å…ƒç´ æ€»æ¯”å­å…ƒç´ å°ã€‚æ¯”å¦‚è¿™å°±æ˜¯ä¸€ä¸ªä¼˜å…ˆé˜Ÿåˆ—å¯èƒ½çš„å†…éƒ¨ç»“æ„ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c26691243fe4fd485d60ca1de01b4fe~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=251&h=251&s=13418&e=png&b=fefefe)

å †é¡¶æ˜¯ `3`ï¼Œå­èŠ‚ç‚¹ `4`ã€`5` å‡æ¯” `3` å°ï¼›`4` çš„å­èŠ‚ç‚¹ `6`ã€`8` ä¹Ÿæ¯” `4` å°ã€‚å½“ç„¶ï¼ŒæŠŠ `6` æŒªåˆ° `5` çš„å­èŠ‚ç‚¹ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªåˆæ³•çš„ä¼˜å…ˆé˜Ÿåˆ—ã€‚åªè¦æ»¡è¶³ä¸Šé¢é‚£ä¸ªæ¡ä»¶ï¼Œæ€ä¹ˆæ’åˆ—æ— æ‰€è°“ã€‚å¦‚æœæˆ‘ä»¬åœ¨å †å°¾æ’å…¥ä¸€ä¸ª `2`ï¼Œå°±ä¼šæ˜¯è¿™æ ·çš„ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4968317be844414da71e477ddb6f0414~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=351&h=255&s=17011&e=png&b=ffffff)

ç„¶åå¯¹å †å°¾è¿›è¡Œæ»¤ä¸Šæ“ä½œï¼Œ`2` æ¯” `5` å°ï¼Œè¦æŠŠ `5` æ¢ä¸‹æ¥ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c0b357a5410c4f6b94dce1d34ac574a9~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=351&h=255&s=16975&e=png&b=ffffff)

ç„¶å `2` æ¯” `3` å°ï¼Œå†æ¢ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/59c58c50ceb74c76bacdf280445c3d0e~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=351&h=255&s=15905&e=png&b=ffffff)

è¿™ä¸ªæ—¶å€™ï¼Œ`2` å°±å¤„äºå †é¡¶äº†ã€‚`3` å˜æˆäº†è¿™ä¸ªä¼˜å…ˆé˜Ÿåˆ—çš„ç¬¬äºŒå°å…ƒç´ ã€‚ç”±äºè¿™æ˜¯ä¸€æœ¬ã€Šè¶£å­¦ Node.jsã€‹å°å†Œï¼Œè€Œéã€Šè¶£å­¦ç®—æ³•ã€‹ã€Šè¶£å­¦æ•°æ®ç»“æ„ã€‹ï¼Œæ›´å¤šå…³äºä¼˜å…ˆé˜Ÿåˆ—çš„ä¿¡æ¯ï¼Œå¤§å®¶å¯è‡ªè¡Œå»ç½‘ä¸Šå­¦ä¹ ï¼Œè¿™é‡Œç‚¹åˆ°ä¸ºæ­¢ã€‚

æ ¹æ®ä¼˜å…ˆé˜Ÿåˆ—çš„äºŒå‰å †æ€§è´¨ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“åˆ¤æ–­å‡ºå †é¡¶å…ƒç´ æ˜¯æœ€å°å…ƒç´ ï¼Œå³ä¼˜å…ˆé˜Ÿåˆ—æ¯æ¬¡éƒ½æ˜¯ä»è¿™å„¿å–ã€‚è€Œå…¶ä¸¤ä¸ªå­èŠ‚ç‚¹éƒ½æ˜¯æ¯”å †é¡¶å…ƒç´ å¤§çš„ï¼Œä½†æ˜¯å®ƒä»¬å„è‡ªåˆæ¯”å„è‡ªçš„å­èŠ‚ç‚¹ä»¬å°ã€‚è™½ç„¶å¯èƒ½ä¼šæœ‰å³å­èŠ‚ç‚¹æ¯”å·¦å­èŠ‚ç‚¹å¤§ï¼Œä¹Ÿæœ‰å¯èƒ½æ¯”å·¦å­èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹éƒ½å¤§ï¼Œä½†è‡³å°‘å®ƒæ¯”è‡ªå·±çš„å­èŠ‚ç‚¹å°ã€‚æ‰€ä»¥å…‰åˆ¤æ–­ç¬¬äºŒå°å…ƒç´ è¿˜æ˜¯å¾ˆå®¹æ˜“çš„ï¼Œåªè¦åˆ¤æ–­å †é¡¶èŠ‚ç‚¹çš„ä¸¤ä¸ªå­èŠ‚ç‚¹è°å°ï¼Œè°å°±æ˜¯ç¬¬äºŒå°äº†ã€‚**å®ƒä»¬ä¿©å…¶ä¸­ä¸€ä¸ªè‚¯å®šæ˜¯ç¬¬äºŒå°çš„ï¼Œä½†æ˜¯å¦ä¸€ä¸ªåˆ™ä¸ä¸€å®šç¬¬ä¸‰å°ã€‚**

è¿™å°±ç›¸å½“äºï¼Œå †é¡¶è‚¯å®šæ˜¯é¾™å¤´ã€‚ç„¶åå·¦å³å­èŠ‚ç‚¹ä¸­è‚¯å®šæ˜¯æœ‰ä¸€ä¸ªå‡¤å¤´ï¼Œå¸¦ç€ä¸€å¸®å‡¤å°å¼Ÿã€‚å¦ä¸€ä¸ªè™½ç„¶ä¹Ÿå¸¦äº†ä¸€å¸®æ¯”å®ƒèœçš„å°å¼Ÿï¼Œä½†å®ƒä¸ä¸€å®šæ¯”å‡¤å°å¼Ÿå‰å®³â€”â€”äººæ‰æ¢¯é˜Ÿé—®é¢˜ï¼Œä»–ä»¬åªæ˜¯å„è‡ªäººæ‰æ¢¯é˜Ÿé‡Œé¢é¡¶å°–çš„ï¼Œä½†æ˜¯æœ‰å¯èƒ½åªæ˜¯ä¸ªé¸¡å¤´ï¼Œæ¯”ä¸ä¸Šå‡¤å°¾ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/892b0c4e53b44a2bbb00713249974001~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=800&h=536&s=575044&e=png&b=1f1e19)

è§£å†³äº†ç¬¬äºŒè¶…æ—¶é“¾è¡¨é—®é¢˜ï¼Œä¸€åˆ‡å°±ç®€å•äº†ã€‚å…ˆæ‰“å¼€ Node.js çš„[ä¼˜å…ˆé˜Ÿåˆ—æºç ](https://github.com/nodejs/node/blob/v18.14.1/lib/internal/priority_queue.js "https://github.com/nodejs/node/blob/v18.14.1/lib/internal/priority_queue.js")ã€‚å¯ä»¥çœ‹åˆ°å®ƒå†…éƒ¨ç”¨ä¸€ä¸ªæ•°ç»„æ¨¡æ‹Ÿäº†å †ã€‚

    class PriorityQueue {
      #compare = (a, b) => a - b;
      #heap = new Array(64);
      ...
    }
    

å †åˆå§‹å¤§å°ä¸º `64`ã€‚ä¸å¹³å¸¸ä½¿ç”¨æ•°ç»„ä¸ä¸€æ ·ï¼Œä¼˜å…ˆé˜Ÿåˆ—é€šå¸¸ç”¨å †çš„ `1` ä¸‹æ ‡ä½œä¸ºæ ¹èŠ‚ç‚¹ï¼Œåœ¨æ­¤å¤„å³ä¸º `#heap[1]`ã€‚ç„¶åæ¯ä¸ªèŠ‚ç‚¹å·¦å³å­èŠ‚ç‚¹ä¸‹æ ‡åˆ†åˆ«ä¸ºçˆ¶èŠ‚ç‚¹ä¹˜äºŒï¼Œä»¥åŠä¹˜äºŒåŠ ä¸€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ ¹èŠ‚ç‚¹å­èŠ‚ç‚¹çš„ä¸‹æ ‡åˆ†åˆ«ä¸º `2`ã€`3`ã€‚è¦å–ç¬¬äºŒå…ƒç´ çš„å€¼ï¼Œç›¸å½“äºåˆ¤æ–­ `2`ã€`3` ä¸‹æ ‡å…ƒç´ å“ªä¸ªå°ã€‚

æˆ‘ä»¬å¯ä»¥ä¸ºå…¶è¡¥ä¸€ä¸ª `secondary()` æ–¹æ³•ï¼š

      secondary() {
        // As the priority queue is a binary heap, the secondary element is
        // always the second or third element in the heap.
        switch (this.#size) {
          case 0:
          case 1:
            return undefined;
    
          case 2:
            return this.#heap[2] === undefined ? this.#heap[3] : this.#heap[2];
    
          default:
            return this.#compare(this.#heap[2], this.#heap[3]) < 0 ?
              this.#heap[2] :
              this.#heap[3];
        }
      }
    

è¿™é‡Œ `#compare` å‡½æ•°ä¸ºæ¯”è¾ƒä¸¤ä¸ªå…ƒç´ å¤§å°çš„å‡½æ•°ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸ºç›´æ¥åˆ¤æ–­æ•°å€¼å¤§å°ã€‚ç„¶è€Œåœ¨ `Timeout` ä¸­ï¼Œæ˜¯ä¸èƒ½ç›´æ¥è¿™ä¹ˆåˆ¤æ–­çš„ã€‚æ‰€ä»¥é’ˆå¯¹ `Timeout` çš„ `#compare` å‡½æ•°æ˜¯åˆ¤æ–­å…¶è¿‡æœŸæ—¶é—´è¿™äº›çš„ã€‚

å¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢è¿™ä¸ª `secondary()` å‡½æ•°åšäº†ä¸€äº›è¾¹ç•Œåˆ¤æ–­ï¼Œå¦‚æ²¡æœ‰ä»»ä½•å…ƒç´ ã€åªæœ‰ä¸€ä¸ªå…ƒç´ ä»¥åŠåªæœ‰ä¸¤ä¸ªå…ƒç´ çš„æ—¶å€™ï¼Œåº”è¯¥å¦‚ä½•è¿”å›ã€‚ç„¶åå‰©ä¸‹çš„æƒ…å†µå°±æŒ‰æˆ‘ä¹‹å‰è®²çš„è¿™ç§æ–¹å¼åˆ¤æ–­ã€‚

æœ‰äº† `secondary()` å‡½æ•°åï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ `listOnTimeout()` ä¸­åšç‚¹æ‰‹è„šå°±å¥½äº†ã€‚å‡è®¾ä½ æ˜¯ Node.js è´¡çŒ®è€…ï¼Œå¯ä»¥åœ¨ `diff < msecs` çš„åˆ¤æ–­ä¸Šåšæ‰‹è„šï¼Œå¦‚ï¼š

    ...
    const secondaryList = timerListQueue.secondary();
    while ((timer = L.peek(list)) != null) {
      ...
      if (diff < msecs || secondaryList?.expiry < timer._idleStart + msecs) {
        ...åŸé€»è¾‘
      }
      ...
    }
    

å¦‚ä¸Šï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨åˆ¤æ–­ `diff < msecs` è¿™é‡Œå¤šåŠ ä¸€ä¸ªæˆ–çš„æ¡ä»¶åˆ¤æ–­å³å¯ï¼Œåˆ¤æ–­å®ƒæ˜¯å¦å¤§äºç¬¬äºŒé“¾è¡¨çš„è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœå¤§äºäº†ï¼Œå°±é‡æ’ä¼˜å…ˆé˜Ÿåˆ—å¹¶å¼€å§‹æ¨ªè·³ã€‚

> #### [PR #46644](https://github.com/nodejs/node/pull/46644 "https://github.com/nodejs/node/pull/46644")
> 
> å®é™…ä¸Šï¼Œè‡ªæˆ‘åœ¨ä¸Šä¸€ç« å‘ç°äº†è¿™ä¸ªé—®é¢˜åï¼Œå°±æäº¤äº†è¿™ä¸ªå°æ’æ›²çš„ PR äº†ã€‚çš„ç¡®æ€§èƒ½æœ‰äº›è®¸åŠ£åŒ–ï¼Œåœ¨æˆ‘çš„ MacBook M1 ä¸Šï¼ŒBenchmark ç²—ç•¥è·‘äº†ä¸€ä¸‹å¦‚ä¸‹ï¼š
> 
>     // åŸé€»è¾‘
>     timers/timers-timeout-unpooled.js n=1000000: 19,307,131.535027202
>     
>     // PR é€»è¾‘
>     timers/timers-timeout-unpooled.js n=1000000: 19,102,850.664916743
>     
> 
> ä¸è¿‡ï¼Œå¯¹äºæ­£ç¡®æ€§æ¥è¯´ï¼Œæˆ‘ä¸ªäººè®¤ä¸ºè¿™ä¸ªåŠ£åŒ–åœ¨å¯æ¥å—èŒƒå›´ã€‚ æœ€ç»ˆ PR åˆå¹¶ä¸åˆå¹¶è¿˜å¾—çœ‹å…¶ä»– TSC æˆ–è€… Collaborator çš„ Reviewã€‚è‹¥æ²¡é€šè¿‡ä¹Ÿæ— æ‰€è°“ï¼Œä¸ºä½ ä»¬è®²è§£çš„ç›®çš„ä¹Ÿè¾¾åˆ°äº†ï¼›è‹¥æœ€ç»ˆé€šè¿‡äº†ï¼Œé‚£ä¹ˆä¸Šä¸€ç« å…³äºè¿™ä¸€å—çš„è–…ç¾Šæ¯›ç®—æ³•å°±ä¼šæˆä¸ºå†å²ï¼Œä»è€Œå˜æˆæ–°çš„åå¤æ¨ªè·³æ³•ã€‚ä½†æ˜¯å¤§å®¶å¤šäº†è§£äº†è§£å†å²é—®é¢˜ä¹ŸæŒºå¥½çš„ã€‚

å°ç»“
--

ä¸Šä¸€ç« ä¸­ï¼Œæˆ‘ä»¬è®²äº† `Timeout` ä¼˜å…ˆé˜Ÿåˆ—æ˜¯å¦‚ä½•è®¿é—®å¹¶è§¦å‘çš„ï¼Œå¹¶æå‡ºè–…ç¾Šæ¯›ç®—æ³•å’Œç å®åº—ç®—æ³•ã€‚è€Œæœ¬ç« ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†çœŸè¿›åˆ°ç¾Šåœˆåï¼Œé‡Œé¢å‘ç”Ÿçš„é€»è¾‘ï¼Œå¦‚ä½•é€ä¸€å°†ç¾Šæ¯›è–…ç§ƒå™œçš®çš„ã€‚åœ¨è¿™é‡Œé¢ä¸ºå¤§å®¶é¿å¼€äº†ä¸€ä¸ª IEEE754 çš„å‘ã€‚å¾ˆå¤šäººæ€»ä»¥ä¸ºè¿™æ˜¯ JavaScript çš„æ•°å­—ä½“ç³»ä¸å¥½ï¼Œå®é™…ä¸Šè¿™è¦æ€ª IEEE754ï¼Œå¹¶é ECMAScriptã€‚æ›´å¤šå…³äºè¿™å—æµ®ç‚¹æ•°çš„å†…å®¹ï¼Œå¤§å®¶ä¹Ÿå¯ä»¥å»çœ‹çœ‹ç½‘ä¸Šçš„èµ„æ–™ï¼Œæˆ–è€…é˜…è¯»ä¸€ä¸‹ã€Š[JavaScript æ‚Ÿé“](https://book.douban.com/subject/35469273/ "https://book.douban.com/subject/35469273/")ã€‹ã€‚

åœ¨ä¸Šä¸€ç« ï¼Œè¿˜é—ç•™äº†ä¸€ä¸ªâ€œä¸é‡è¦ã€æš‚ä¸”ä¸æâ€çš„ `uv_ref()` ä¸ `uv_unref()`ï¼Œåœ¨æœ¬ç« ä¸­ä¹Ÿä¸ºå¤§å®¶æè¿°æ¸…æ¥šäº†å…¶ç”¨é€”ï¼Œä»¥åŠå®ƒä¸ `timer` ä¸­çš„ `timer.ref()`ã€`timer.unref()` çš„å…³ç³»ã€‚

æœ€åï¼Œæ¥äº†ä¸€ä¸ªå°æ’æ›²ï¼Œä»¥èº«è¯•æ³•ï¼Œä»¥è´¡çŒ®è€…çš„æ€è·¯ï¼Œä¸€æ­¥æ­¥è§£ææˆ‘ä»¬å¯ä»¥å¦‚ä½•åˆ†æé—®é¢˜ï¼Œå¹¶ä¸”é€šè¿‡æ€ä¹ˆæ ·çš„ä¿®æ”¹ï¼Œèƒ½è§£å†³ä¸Šä¸€ç« ä¸­é—ç•™çš„æ—¶åºé—®é¢˜ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2873eac1c4964dbc8be829120d0f17fb~tplv-k3u1fbpfcp-jj-mark:1600:0:0:0:q75.image#?w=658&h=370&s=54312&e=png&b=faf8f8)